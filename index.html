<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netflics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #e50914;
            --dark: #141414;
            --light: #fff;
            --gray: #aaa;
            --overlay: rgba(0,0,0,0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--dark);
            color: var(--light);
            overflow-x: hidden;
            padding-bottom: 50px;
        }

        /* --- Header --- */
        .header {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 20px 4%;
            background: linear-gradient(180deg, rgba(0,0,0,0.7) 10%, transparent);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            transition: background-color 0.3s;
        }

        .header.scrolled {
            background-color: var(--dark);
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary);
            text-transform: uppercase;
            cursor: pointer;
        }

        .search-container {
            display: flex;
            gap: 10px;
            background: rgba(0,0,0,0.5);
            border: 1px solid #fff;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .search-input {
            background: transparent;
            border: none;
            color: #fff;
            outline: none;
            width: 200px;
        }

        /* --- Hero --- */
        .hero {
            height: 85vh;
            position: relative;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            padding: 0 4%;
        }

        .hero::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to right, rgba(0,0,0,0.9) 0%, transparent 60%, rgba(0,0,0,0.4) 100%);
        }

        .hero::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: linear-gradient(to top, var(--dark), transparent);
        }

        .hero-content {
            position: relative;
            z-index: 10;
            max-width: 600px;
            margin-top: 50px;
        }

        .hero-title {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .hero-overview {
            font-size: 1.1rem;
            line-height: 1.5;
            margin-bottom: 2rem;
            color: #ddd;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .btn {
            padding: 10px 25px;
            border-radius: 4px;
            border: none;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.2s;
        }

        .btn:hover { transform: scale(1.05); }

        .btn-play { background: #fff; color: #000; }
        .btn-info { background: rgba(109,109,110,0.7); color: #fff; margin-left: 10px; }

        /* --- Navigation & Filters --- */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }

        .nav-tab {
            cursor: pointer;
            color: var(--gray);
            font-size: 1.2rem;
            font-weight: bold;
            transition: 0.3s;
            position: relative;
        }

        .nav-tab.active, .nav-tab:hover { color: #fff; }
        .nav-tab.active::after {
            content: '';
            display: block;
            width: 100%;
            height: 3px;
            background: var(--primary);
            position: absolute;
            bottom: -5px;
        }

        .genres {
            display: flex;
            gap: 10px;
            padding: 10px 4%;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .genres::-webkit-scrollbar { display: none; }

        .genre-pill {
            padding: 5px 15px;
            border: 1px solid #aaa;
            border-radius: 20px;
            white-space: nowrap;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.9rem;
        }

        .genre-pill.active, .genre-pill:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        /* --- Content Rows --- */
        .content-section { padding: 20px 0; padding-left: 4%; }
        
        .row-header {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: #e5e5e5;
        }

        .row-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 20px;
            padding-right: 4%;
            scroll-behavior: smooth;
        }
        .row-container::-webkit-scrollbar { height: 5px; }
        .row-container::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

        .card {
            flex: 0 0 auto;
            width: 200px;
            height: 300px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s;
            background: #222;
        }

        .card:hover {
            transform: scale(1.1);
            z-index: 100;
        }

        .card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* --- Modal --- */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            overflow-y: auto;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal.show { opacity: 1; }

        .modal-box {
            background: #181818;
            width: 90%;
            max-width: 900px;
            margin: 50px auto;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #181818;
            color: #fff;
            border: none;
            font-size: 24px;
            cursor: pointer;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-hero {
            height: 400px;
            background-size: cover;
            position: relative;
        }
        .modal-hero::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, #181818, transparent);
        }

        .modal-info { padding: 30px; }
        
        .modal-meta {
            color: #46d369;
            font-weight: bold;
            margin: 10px 0;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .action-row {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .episode-select {
            background: #333;
            color: #fff;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 4px;
        }

        /* --- Fullscreen Video Player --- */
        .video-player {
            display: none;
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 3000;
        }
        
        .video-player iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .close-player {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            color: #fff;
            border: 2px solid #fff;
            padding: 10px 20px;
            cursor: pointer;
            z-index: 3001;
            font-weight: bold;
            border-radius: 4px;
        }

        /* --- Loading & Utilities --- */
        .loading-spinner {
            text-align: center;
            padding: 50px;
            color: var(--primary);
            font-size: 20px;
        }

        .my-list-btn.added {
            background: rgba(255,255,255,0.2);
            color: #46d369;
        }

        /* --- Mobile Responsive --- */
        @media (max-width: 768px) {
            .hero-title { font-size: 2.5rem; }
            .card { width: 140px; height: 210px; }
            .modal-hero { height: 250px; }
            .header { padding: 15px 4%; }
            .search-input { width: 120px; }
            .search-input:focus { width: 180px; transition: width 0.3s; }
        }
    </style>
</head>
<body>

    <header class="header" id="header">
        <div class="logo" onclick="location.reload()">NETFLICS</div>
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" class="search-input" id="searchInput" placeholder="Titoli, persone, generi">
        </div>
    </header>

    <div class="nav-tabs">
        <div class="nav-tab active" onclick="switchTab('movie')">Film</div>
        <div class="nav-tab" onclick="switchTab('tv')">Serie TV</div>
        <div class="nav-tab" onclick="loadMyList()">La mia Lista</div>
    </div>

    <div class="genres" id="genreFilters"></div>

    <div class="hero" id="hero">
        <div class="hero-content">
            <h1 class="hero-title" id="heroTitle">Caricamento...</h1>
            <p class="hero-overview" id="heroOverview"></p>
            <div class="hero-buttons">
                <button class="btn btn-play" id="heroPlayBtn"><i class="fas fa-play"></i> Riproduci</button>
                <button class="btn btn-info" id="heroInfoBtn"><i class="fas fa-info-circle"></i> Altre info</button>
            </div>
        </div>
    </div>

    <div id="mainContent"></div>

    <div class="video-player" id="videoPlayer">
        <button class="close-player" onclick="closePlayer()">✕ Chiudi Player</button>
        <iframe id="playerFrame" allowfullscreen></iframe>
    </div>

    <div class="modal" id="modal">
        <div class="modal-box">
            <button class="modal-close" onclick="closeModal()">×</button>
            <div class="modal-hero" id="modalBackdrop"></div>
            <div class="modal-info">
                <h2 id="modalTitle" style="font-size: 2rem; margin-bottom: 10px;"></h2>
                <div class="modal-meta" id="modalMeta"></div>
                <p id="modalOverview" style="line-height: 1.6; color: #ccc; margin-bottom: 20px;"></p>
                
                <div id="seriesControls" style="display:none; margin-bottom: 20px;">
                    <select id="seasonSelect" class="episode-select" onchange="updateEpisodes()"></select>
                    <select id="episodeSelect" class="episode-select"></select>
                </div>

                <div class="action-row">
                    <button class="btn btn-play" onclick="playCurrentMedia()">
                        <i class="fas fa-play"></i> Riproduci
                    </button>
                    <button class="btn btn-info my-list-btn" id="modalListBtn" onclick="toggleMyList()">
                        <i class="fas fa-plus"></i> La mia Lista
                    </button>
                    <button class="btn btn-info" id="trailerBtn" style="display:none;">
                        <i class="fab fa-youtube"></i> Trailer
                    </button>
                </div>

                <div id="similarContent"></div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const API_KEY = 'ca20c0945f1bea10a8f9212a3f53a518'; // Nota: In produzione usa un backend proxy
        const BASE_URL = 'https://api.themoviedb.org/3';
        const IMG_URL = 'https://image.tmdb.org/t/p/original';
        const IMG_SMALL = 'https://image.tmdb.org/t/p/w500';

        // STATE
        let state = {
            type: 'movie', // 'movie' or 'tv'
            genre: null,
            modalItem: null,
            myList: JSON.parse(localStorage.getItem('netflics_list')) || [],
            continueWatching: JSON.parse(localStorage.getItem('netflics_progress')) || {}
        };

        // DOM ELEMENTS
        const contentDiv = document.getElementById('mainContent');
        const modal = document.getElementById('modal');

        // --- INIT ---
        window.addEventListener('scroll', () => {
            const header = document.getElementById('header');
            header.classList.toggle('scrolled', window.scrollY > 50);
        });

        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') performSearch(e.target.value);
        });

        init();

        async function init() {
            await loadGenres();
            await loadHero();
            await loadHomeContent();
        }

        // --- API & DATA ---
        async function fetchAPI(endpoint) {
            try {
                const res = await fetch(`${BASE_URL}${endpoint}${endpoint.includes('?') ? '&' : '?'}api_key=${API_KEY}&language=it-IT`);
                return await res.json();
            } catch (e) {
                console.error("API Error", e);
                return null;
            }
        }

        async function loadGenres() {
            const data = await fetchAPI(`/genre/${state.type}/list`);
            const container = document.getElementById('genreFilters');
            if (data && data.genres) {
                container.innerHTML = `<div class="genre-pill active" onclick="setGenre(null, this)">Tutti</div>` + 
                    data.genres.map(g => `<div class="genre-pill" onclick="setGenre(${g.id}, this)">${g.name}</div>`).join('');
            }
        }

        async function loadHero() {
            const data = await fetchAPI(`/${state.type}/trending/week`);
            if (!data.results.length) return;
            
            const item = data.results[Math.floor(Math.random() * 5)]; // Random top 5
            const bg = item.backdrop_path ? `url(${IMG_URL}${item.backdrop_path})` : '#000';
            
            document.getElementById('hero').style.backgroundImage = bg;
            document.getElementById('heroTitle').textContent = item.title || item.name;
            document.getElementById('heroOverview').textContent = item.overview;
            
            document.getElementById('heroPlayBtn').onclick = () => openDetails(item, true);
            document.getElementById('heroInfoBtn').onclick = () => openDetails(item);
        }

        // --- CONTENT RENDERING ---
        async function loadHomeContent() {
            contentDiv.innerHTML = '';
            
            // 1. Continue Watching
            renderContinueWatching();

            // 2. Categories
            const categories = state.type === 'movie' 
                ? [
                    { t: 'Popolari su Netflics', url: '/movie/popular' },
                    { t: 'I più votati', url: '/movie/top_rated' },
                    { t: 'In arrivo', url: '/movie/upcoming' },
                    { t: 'Azione', url: '/discover/movie?with_genres=28' }
                  ]
                : [
                    { t: 'Serie TV del momento', url: '/tv/popular' },
                    { t: 'Le più votate', url: '/tv/top_rated' },
                    { t: 'In onda oggi', url: '/tv/airing_today' },
                    { t: 'Crime', url: '/discover/tv?with_genres=80' }
                  ];

            for (const cat of categories) {
                const data = await fetchAPI(cat.url);
                if (data && data.results) createRow(cat.t, data.results);
            }
        }

        function renderContinueWatching() {
            const items = Object.values(state.continueWatching).filter(i => i.type === state.type);
            if (items.length > 0) {
                // Ordina per ultimo visto
                items.sort((a,b) => b.timestamp - a.timestamp);
                createRow('Continua a guardare', items, true);
            }
        }

        function createRow(title, items, isHistory = false) {
            if (!items.length) return;
            
            const rowDiv = document.createElement('div');
            rowDiv.className = 'content-section';
            rowDiv.innerHTML = `<h3 class="row-header">${title}</h3>`;
            
            const container = document.createElement('div');
            container.className = 'row-container';
            
            items.forEach(item => {
                if (!item.poster_path && !item.poster) return;
                const imgPath = item.poster_path ? IMG_SMALL + item.poster_path : IMG_SMALL + item.poster;
                
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <img src="${imgPath}" loading="lazy" alt="${item.title || item.name}">
                    ${isHistory ? '<div style="position:absolute;bottom:0;left:0;height:3px;background:red;width:50%"></div>' : ''}
                `;
                
                // Se è history, l'oggetto è leggermente diverso, normalizziamo per il modal
                const itemData = isHistory ? { id: item.id, title: item.title, name: item.title, poster_path: item.poster, overview: item.overview, backdrop_path: item.backdrop } : item;
                
                card.onclick = () => openDetails(itemData);
                container.appendChild(card);
            });

            rowDiv.appendChild(container);
            contentDiv.appendChild(rowDiv);
        }

        // --- NAVIGATION ACTIONS ---
        function switchTab(type) {
            state.type = type;
            state.genre = null;
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            loadGenres();
            loadHero();
            loadHomeContent();
        }

        async function setGenre(id, el) {
            document.querySelectorAll('.genre-pill').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            
            if (id === null) {
                loadHomeContent();
                return;
            }

            contentDiv.innerHTML = '<div class="loading-spinner">Caricamento...</div>';
            const data = await fetchAPI(`/discover/${state.type}?with_genres=${id}`);
            contentDiv.innerHTML = '';
            createRow(`Risultati: ${el.innerText}`, data.results);
        }

        function loadMyList() {
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            contentDiv.innerHTML = '';
            
            if (state.myList.length === 0) {
                contentDiv.innerHTML = '<div class="loading-spinner">La tua lista è vuota.</div>';
                return;
            }
            createRow('La mia Lista', state.myList);
        }

        async function performSearch(query) {
            if (!query) return;
            contentDiv.innerHTML = '<div class="loading-spinner">Ricerca in corso...</div>';
            
            const movieSearch = await fetchAPI(`/search/movie?query=${query}`);
            const tvSearch = await fetchAPI(`/search/tv?query=${query}`);
            
            contentDiv.innerHTML = '';
            if (movieSearch.results.length) createRow('Film trovati', movieSearch.results);
            if (tvSearch.results.length) createRow('Serie TV trovate', tvSearch.results);
            
            if (!movieSearch.results.length && !tvSearch.results.length) {
                contentDiv.innerHTML = '<div class="loading-spinner">Nessun risultato trovato.</div>';
            }
        }

        // --- MODAL & DETAILS ---
        async function openDetails(item, autoPlay = false) {
            state.modalItem = item;
            // Fetch dettagli completi per avere info extra (es. stagioni)
            const type = item.title ? 'movie' : (item.name ? 'tv' : state.type); // Fallback detection
            const details = await fetchAPI(`/${type}/${item.id}`);
            
            if (!details) return; // Error handling

            // Populate Modal
            document.getElementById('modalTitle').innerText = details.title || details.name;
            document.getElementById('modalOverview').innerText = details.overview || "Nessuna descrizione.";
            document.getElementById('modalBackdrop').style.backgroundImage = `url(${IMG_URL}${details.backdrop_path})`;
            
            const year = (details.release_date || details.first_air_date || '').substring(0,4);
            const rating = details.vote_average ? `★ ${details.vote_average.toFixed(1)}` : '';
            const runtime = details.runtime ? `${details.runtime}m` : (details.number_of_seasons ? `${details.number_of_seasons} Stagioni` : '');
            
            document.getElementById('modalMeta').innerHTML = `<span>${year}</span> <span>${rating}</span> <span>${runtime}</span>`;

            // My List Button State
            updateMyListBtn(details.id);

            // Trailer
            const videos = await fetchAPI(`/${type}/${details.id}/videos`);
            const trailerBtn = document.getElementById('trailerBtn');
            const trailer = videos?.results.find(v => v.site === 'YouTube' && v.type === 'Trailer');
            if (trailer) {
                trailerBtn.style.display = 'inline-flex';
                trailerBtn.onclick = () => window.open(`https://www.youtube.com/watch?v=${trailer.key}`, '_blank');
            } else {
                trailerBtn.style.display = 'none';
            }

            // Series Logic
            const seriesControls = document.getElementById('seriesControls');
            if (type === 'tv') {
                seriesControls.style.display = 'block';
                const sSelect = document.getElementById('seasonSelect');
                sSelect.innerHTML = details.seasons
                    .filter(s => s.season_number > 0)
                    .map(s => `<option value="${s.season_number}">Stagione ${s.season_number}</option>`).join('');
                
                await updateEpisodes(); // Load ep for season 1
                
                // Restore progress if exists
                if (state.continueWatching[details.id]) {
                    sSelect.value = state.continueWatching[details.id].season;
                    await updateEpisodes();
                    document.getElementById('episodeSelect').value = state.continueWatching[details.id].episode;
                }
            } else {
                seriesControls.style.display = 'none';
            }

            // Similar
            const similar = await fetchAPI(`/${type}/${details.id}/similar`);
            const similarContainer = document.getElementById('similarContent');
            similarContainer.innerHTML = '';
            if (similar && similar.results.length) {
                similarContainer.innerHTML = '<h4>Potrebbe piacerti anche:</h4>';
                const grid = document.createElement('div');
                grid.className = 'row-container';
                grid.style.marginTop = '10px';
                
                similar.results.slice(0, 6).forEach(s => {
                    if(s.poster_path) {
                        const d = document.createElement('div');
                        d.className = 'card';
                        d.style.width = '120px'; // Smaller for similar
                        d.style.height = '180px';
                        d.innerHTML = `<img src="${IMG_SMALL}${s.poster_path}">`;
                        d.onclick = () => { closeModal(); setTimeout(() => openDetails(s), 300); };
                        grid.appendChild(d);
                    }
                });
                similarContainer.appendChild(grid);
            }

            modal.style.display = 'block';
            setTimeout(() => modal.classList.add('show'), 10);

            if (autoPlay) playCurrentMedia();
        }

        function closeModal() {
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // --- EPISODES LOGIC ---
        async function updateEpisodes() {
            const tvId = state.modalItem.id;
            const seasonNum = document.getElementById('seasonSelect').value;
            const epSelect = document.getElementById('episodeSelect');
            
            epSelect.innerHTML = '<option>Caricamento...</option>';
            
            const data = await fetchAPI(`/tv/${tvId}/season/${seasonNum}`);
            if (data && data.episodes) {
                epSelect.innerHTML = data.episodes.map(e => 
                    `<option value="${e.episode_number}">Ep. ${e.episode_number} - ${e.name}</option>`
                ).join('');
            }
        }

        // --- PLAYER & PERSISTENCE ---
        function playCurrentMedia() {
            const item = state.modalItem;
            const isTv = document.getElementById('seriesControls').style.display !== 'none';
            let url = '';
            let saveObj = {
                id: item.id,
                title: item.title || item.name,
                poster: item.poster_path,
                backdrop: item.backdrop_path,
                type: isTv ? 'tv' : 'movie',
                timestamp: Date.now()
            };

            if (isTv) {
                const s = document.getElementById('seasonSelect').value;
                const e = document.getElementById('episodeSelect').value;
                url = `https://vixsrc.to/tv/${item.id}/${s}/${e}?lang=it`;
                saveObj.season = s;
                saveObj.episode = e;
            } else {
                url = `https://vixsrc.to/movie/${item.id}?lang=it`;
            }

            // Save Progress
            state.continueWatching[item.id] = saveObj;
            localStorage.setItem('netflics_progress', JSON.stringify(state.continueWatching));

            // Open Player
            const playerDiv = document.getElementById('videoPlayer');
            const iframe = document.getElementById('playerFrame');
            iframe.src = url;
            playerDiv.style.display = 'block';
        }

        function closePlayer() {
            const iframe = document.getElementById('playerFrame');
            iframe.src = ''; // Stop video
            document.getElementById('videoPlayer').style.display = 'none';
            loadHomeContent(); // Refresh "Continue Watching" row
        }

        // --- MY LIST ---
        function toggleMyList() {
            const item = state.modalItem;
            const index = state.myList.findIndex(i => i.id === item.id);
            
            if (index === -1) {
                state.myList.push(item);
            } else {
                state.myList.splice(index, 1);
            }
            
            localStorage.setItem('netflics_list', JSON.stringify(state.myList));
            updateMyListBtn(item.id);
        }

        function updateMyListBtn(id) {
            const btn = document.getElementById('modalListBtn');
            const inList = state.myList.some(i => i.id === id);
            
            if (inList) {
                btn.innerHTML = '<i class="fas fa-check"></i> Rimouvi dalla Lista';
                btn.classList.add('added');
            } else {
                btn.innerHTML = '<i class="fas fa-plus"></i> La mia Lista';
                btn.classList.remove('added');
            }
        }

        // Close modal on outside click
        window.onclick = (e) => {
            if (e.target === modal) closeModal();
        }

    </script>
</body>
</html>
